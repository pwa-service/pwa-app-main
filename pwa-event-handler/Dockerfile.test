FROM node:22-bookworm-slim

WORKDIR /workspace

RUN apt-get update && apt-get install -y --no-install-recommends \
  ca-certificates openssl python3 make g++ \
  && rm -rf /var/lib/apt/lists/*

COPY ./pwa-event-handler/package*.json ./pwa-event-handler/
COPY ./pwa-prisma/package*.json       ./pwa-prisma/
COPY ./pwa-shared/package*.json       ./pwa-shared/
COPY ./pwa-protos/package*.json       ./pwa-protos/

WORKDIR /workspace/pwa-event-handler
RUN npm ci

WORKDIR /workspace/pwa-prisma
RUN npm ci

WORKDIR /workspace/pwa-shared
RUN npm ci

WORKDIR /workspace
COPY ./pwa-event-handler ./pwa-event-handler
COPY ./pwa-prisma       ./pwa-prisma
COPY ./pwa-shared       ./pwa-shared
COPY ./pwa-protos       ./pwa-protos

WORKDIR /workspace/pwa-prisma
RUN npx prisma generate --schema=./prisma/schema.prisma

WORKDIR /workspace/pwa-event-handler
RUN mkdir -p ./prisma \
 && cp ../pwa-prisma/prisma/schema.prisma ./prisma/schema.prisma
RUN npx prisma generate --schema=./prisma/schema.prisma

RUN mkdir -p ./protos \
 && cp -r ../pwa-protos/protos/* ./protos/

ENV NODE_ENV=test
CMD ["npm", "run", "test:ci"]