generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =========================
// ENUMS
// =========================

enum Status {
  active
  inactive
}

enum ScopeType {
  SYSTEM
  CAMPAIGN
  TEAM
}

enum PwaStatus {
  draft
  published
  archived
}

enum FlowStatus {
  draft
  published
  archived
}

enum TaskStatus {
  open
  in_progress
  closed
}

enum LogStatus {
  success
  error
}

enum AlertType {
  info
  warn
  error
  fatal
}

enum EventType {
  ViewContent
  PageView
  Lead
  CompleteRegistration
  Purchase
  Subscribe
}

enum ErrorLevel {
  Anomaly
  TechError
  TokenExpirity
  TrashholdReached
  info
  warn
  error
  fatal
}

enum AccessLevel {
  None
  View
  Edit
  Manage
}

enum WorkingObjectType {
  PWA
  FLOW
  PIXEL_TOKEN
  TEAM
  CAMPAIGN
}

enum ObjectRelationType {
  DependsOn
  Owns
  Uses
}

enum DeviceType {
  mobile
  desktop
}

enum DeviceOs {
  Linux
  Windows
  MacOS
  Android
  IOS
}

enum WorkingObjectUserRelation {
  Owner
  Editor
  Viewer
}

// =========================
// AUTH & IDENTITY (Base Layer)
// =========================

model UserProfile {
  id           String    @id @default(uuid())
  username     String    @unique
  passwordHash String?   @map("password_hash")
  email        String?
  status       Status    @default(inactive)
  scope        ScopeType
  tgId         BigInt?
  createdAt    DateTime  @default(now()) @map("created_at")

  // Context Identities
  systemUser   SystemUser?
  campaignUser CampaignUser?
  teamUser     TeamUser?

  // Logs & Tasks
  auditLogs AuditLog[]
  errorLogs ErrorLog[]
  tasks     Task[]

  // Sharing Interactions
  sharesReceived ShareUserProfile[] @relation("UserProfileShares")
  sharesCreated  ShareUserProfile[] @relation("UserProfileShareCreator")

  // Ownership & Links
  campaignsOwned   Campaign[]         @relation("LegalCampaignOwner")
  domainsOwned     Domain[]           @relation("DomainOwner")
  PixelToken       PixelToken[]
  PwaVersion       PwaVersion[]
  FlowVersion      FlowVersion[]
  PwaSession       PwaSession[]
  EventLog         EventLog[]
  GlobalAccessUser GlobalAccessUser[]

  @@map("user_profiles")
}

// =========================
// UNIFIED ROLE MANAGEMENT
// =========================

model Role {
  id          Int       @id @default(autoincrement())
  name        String
  priority    Int       @default(100)
  description String?   @db.Text
  scope       ScopeType

  // Context Links
  campaignId String? @map("campaign_id")
  teamId     String? @map("team_id")

  campaign Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  team     Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // Permissions & Shares
  accessProfile RoleAccess?
  shares        ShareRole[]

  // Members
  systemUsers   SystemUser[]
  campaignUsers CampaignUser[]
  teamUsers     TeamUser[]

  @@unique([name, campaignId, teamId])
  @@map("roles")
}

model RoleAccess {
  id              String   @id @default(uuid())
  roleId          Int      @unique @map("role_id")
  accessProfileId String   @map("access_profile_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  role          Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  accessProfile AccessProfile @relation(fields: [accessProfileId], references: [id])

  @@map("role_access")
}

// =========================
// CONTEXT USERS
// =========================

model SystemUser {
  id            String   @id @default(uuid())
  userProfileId String   @unique @map("user_profile_id")
  roleId        Int      @map("role_id")
  createdAt     DateTime @default(now()) @map("created_at")

  profile UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  role    Role        @relation(fields: [roleId], references: [id])

  @@map("system_users")
}

model CampaignUser {
  id            String   @id @default(uuid())
  userProfileId String   @unique @map("user_profile_id")
  campaignId    String   @map("campaign_id")
  roleId        Int      @map("role_id")
  createdAt     DateTime @default(now()) @map("created_at")

  profile  UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  campaign Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  role     Role        @relation(fields: [roleId], references: [id])

  pwaAppsCreated PwaApp[] @relation("PwaCreator")
  flowsCreated   Flow[]   @relation("FlowCreator")

  sharesCreatedRole ShareRole[] @relation("ShareRoleCreator")

  @@map("campaign_users")
}

model TeamUser {
  id            String   @id @default(uuid())
  userProfileId String   @unique @map("user_profile_id")
  teamId        String   @map("team_id")
  roleId        Int      @map("role_id")
  createdAt     DateTime @default(now()) @map("created_at")

  profile UserProfile @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  team    Team        @relation(fields: [teamId], references: [id], onDelete: Cascade)
  role    Role        @relation(fields: [roleId], references: [id])

  pwaAppsCreated PwaApp[] @relation("TeamPwaCreator")
  flowsCreated   Flow[]   @relation("TeamFlowCreator")

  sharesCreatedRole  ShareRole[]             @relation("ShareRoleCreatorTeam")
  workingObjectLinks WorkingObjectTeamUser[]

  TeamLeaderOf Team[] @relation("TeamLeader")

  @@map("team_users")
}

// =========================
// ORG STRUCTURE
// =========================

model Admin {
  id           String   @id @default(uuid())
  username     String   @unique
  passwordHash String?  @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("admin")
}

model Campaign {
  id           String   @id @default(uuid())
  name         String   @unique
  legalOwnerId String?  @map("legal_owner_id")
  createdAt    DateTime @default(now()) @map("created_at")

  owner UserProfile? @relation("LegalCampaignOwner", fields: [legalOwnerId], references: [id])

  teams   Team[]
  members CampaignUser[]
  roles   Role[]

  pwaApps     PwaApp[]
  pixelTokens PixelToken[]
  flows       Flow[]
  pwaSessions PwaSession[]
  eventLogs   EventLog[]
  financials  Financial[]
  alerts      Alert[]
  tasks       Task[]

  workingObjectLink WorkingObjectCampaign?

  @@map("campaigns")
}

model Team {
  id                 String   @id @default(uuid())
  name               String
  campaignId         String   @map("campaign_id")
  teamLeadId         String?  @map("team_lead_id")
  sharePwaWithinTeam Boolean  @default(false) @map("share_pwa_within_team")
  createdAt          DateTime @default(now()) @map("created_at")

  campaign Campaign  @relation(fields: [campaignId], references: [id])
  teamLead TeamUser? @relation("TeamLeader", fields: [teamLeadId], references: [id])

  members TeamUser[]
  roles   Role[]

  pwaApps     PwaApp[]
  pixelTokens PixelToken[]
  flows       Flow[]
  pwaSessions PwaSession[]
  eventLogs   EventLog[]

  workingObjectLink WorkingObjectTeam?

  @@map("teams")
}

// =========================
// ASSETS & PWA
// =========================

model Domain {
  id       String  @id @default(uuid())
  hostname String  @unique
  status   Status  @default(active)
  pwaAppId String? @map("pwa_app_id")
  ownerId  String? @map("owner_id")

  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")
  pwaApp    PwaApp?      @relation(fields: [pwaAppId], references: [id])
  owner     UserProfile? @relation("DomainOwner", fields: [ownerId], references: [id])

  eventLogs EventLog[]

  @@map("domains")
}

model PixelToken {
  id          String    @id @default(uuid())
  token       String    @unique
  description String?
  ownerId     String?   @map("owner_id")
  campaignId  String?   @map("campaign_id")
  teamId      String?   @map("team_id")
  status      Status    @default(active)
  createdAt   DateTime? @default(now()) @map("created_at")
  updatedAt   DateTime? @updatedAt @map("updated_at")

  owner    UserProfile? @relation(fields: [ownerId], references: [id])
  campaign Campaign?    @relation(fields: [campaignId], references: [id])
  team     Team?        @relation(fields: [teamId], references: [id])

  pwaApps   PwaApp[]
  sessions  PwaSession[]
  eventLogs EventLog[]

  workingObjectLink WorkingObjectPixelToken?

  @@map("pixel-token-manager")
}

model PwaApp {
  id           String    @id @default(uuid())
  name         String
  status       PwaStatus @default(draft)
  campaignId   String    @map("campaign_id")
  teamId       String?   @map("team_id")
  pixelTokenId String?   @map("pixel_token_id")
  domainId     String    @map("domain_id")
  isDeleted    Boolean   @default(false) @map("is_deleted")

  mainLocale String? @default("en") @map("main_locale")

  destinationUrl String? @map("destination_url")
  productUrl     String? @map("product_url")

  author           String? @map("author")
  rating           String? @map("rating")
  adsText          String? @map("ads_text")
  category         String? @map("category")
  categorySubtitle String? @map("category_subtitle")

  installCount      Int?    @map("install_count")
  installCountLabel String? @map("install_count_label")

  reviewsCount      Int?    @map("reviews_count")
  reviewsCountLabel String? @map("reviews_count_label")

  appSize      Float?  @map("app_size")
  appSizeLabel String? @map("app_size_label")

  ageLimit      Int?    @map("age_limit")
  ageLimitLabel String? @map("age_limit_label")

  iconUrl     String?  @map("icon_url")
  galleryUrls String[] @map("gallery_urls")

  createdByCampaignUserId String? @map("created_by_campaign_user_id")
  createdByTeamUserId     String? @map("created_by_team_user_id")

  createdAt DateTime? @default(now()) @map("created_at")
  updatedAt DateTime? @updatedAt @map("updated_at")

  campaign Campaign @relation(fields: [campaignId], references: [id])
  team     Team?    @relation(fields: [teamId], references: [id])

  creatorCampaign CampaignUser? @relation("PwaCreator", fields: [createdByCampaignUserId], references: [id])
  creatorTeam     TeamUser?     @relation("TeamPwaCreator", fields: [createdByTeamUserId], references: [id])

  pixelToken PixelToken? @relation(fields: [pixelTokenId], references: [id])

  domains      Domain[]
  details      PwaDetails?
  contents     PwaContent[]
  eventsConfig PwaEventsConfig[]
  versions     PwaVersion[]
  flows        Flow[]
  sessions     PwaSession[]
  eventLogs    EventLog[]

  // --- Нові реляційні таблиці ---
  tags     PwaTag[]
  terms    PwaTerm[]
  comments PwaComment[]

  // --- Новий профіль подій ---
  eventsProfile PwaEventsProfile?

  workingObjectLink WorkingObjectPwa?

  @@map("pwa_apps")
}

model PwaDetails {
  id          String  @id @default(uuid())
  pwaAppId    String  @unique @map("pwa_app_id")
  publicName  String? @map("public_name")
  iconUrl     String? @map("icon_url")
  logoUrl     String? @map("logo_url")
  themeColor  String? @map("theme_color")
  screenshots Json?

  // Легасі поля можна залишити або видалити, якщо ви повністю перейшли на PwaTerm/PwaTag
  // privacyPolicy  String? @map("privacy_policy") @db.Text
  // termsOfService String? @map("terms_of_service") @db.Text
  // tags           String?

  pwaApp PwaApp @relation(fields: [pwaAppId], references: [id])

  @@map("pwa_details")
}

model PwaContent {
  id          String  @id @default(uuid())
  pwaAppId    String  @map("pwa_app_id")
  locale      String?
  title       String?
  description String? @db.Text

  // Коментарі тепер у PwaComment, це поле можна залишити як легасі або для іншого типу контенту
  // comments    Json?

  pwaApp PwaApp @relation(fields: [pwaAppId], references: [id])

  @@map("pwa_contents")
}

// --- Нові таблиці для нормалізованих даних ---

model PwaTag {
  id       String @id @default(uuid())
  text     String
  pwaAppId String @map("pwa_app_id")
  pwaApp   PwaApp @relation(fields: [pwaAppId], references: [id], onDelete: Cascade)

  @@map("pwa_tags")
}

model PwaTerm {
  id       String @id @default(uuid())
  text     String @db.Text
  pwaAppId String @map("pwa_app_id")
  pwaApp   PwaApp @relation(fields: [pwaAppId], references: [id], onDelete: Cascade)

  @@map("pwa_terms")
}

model PwaComment {
  id       String @id @default(uuid())
  author   String
  text     String @db.Text
  pwaAppId String @map("pwa_app_id")
  pwaApp   PwaApp @relation(fields: [pwaAppId], references: [id], onDelete: Cascade)

  @@map("pwa_comments")
}

model PwaEventsProfile {
  id       String @id @default(uuid())
  pwaAppId String @unique @map("pwa_app_id")

  viewContent Boolean @default(false) @map("view_content")
  firstOpen   Boolean @default(false) @map("first_open")
  reg         Boolean @default(false) @map("reg")
  sub         Boolean @default(false) @map("sub")
  dep         Boolean @default(false) @map("dep")
  redep       Boolean @default(false) @map("redep")

  pwaApp PwaApp @relation(fields: [pwaAppId], references: [id], onDelete: Cascade)

  @@map("pwa_events_profile")
}

model PwaEventsConfig {
  id          String     @id @default(uuid())
  pwaAppId    String     @map("pwa_app_id")
  eventType   EventType? @map("event_type")
  destination String?

  pwaApp PwaApp @relation(fields: [pwaAppId], references: [id])

  @@map("pwa_events_config")
}

model PwaVersion {
  id            String    @id @default(uuid())
  pwaAppId      String    @map("pwa_app_id")
  versionNumber Int?      @map("version_number")
  changedBy     String?   @map("changed_by")
  createdAt     DateTime? @default(now()) @map("created_at")

  pwaApp  PwaApp       @relation(fields: [pwaAppId], references: [id])
  changer UserProfile? @relation(fields: [changedBy], references: [id])

  @@map("pwa_versions")
}

model Flow {
  id     String     @id @default(uuid())
  name   String
  status FlowStatus @default(draft)

  campaignId String  @map("campaign_id")
  teamId     String? @map("team_id")

  createdByCampaignUserId String? @map("created_by_campaign_user_id")
  createdByTeamUserId     String? @map("created_by_team_user_id")

  pwaAppId        String? @map("pwa_app_id")
  activeVersionId String? @map("active_version_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  campaign Campaign @relation(fields: [campaignId], references: [id])
  team     Team?    @relation(fields: [teamId], references: [id])

  creatorCampaign CampaignUser? @relation("FlowCreator", fields: [createdByCampaignUserId], references: [id])
  creatorTeam     TeamUser?     @relation("TeamFlowCreator", fields: [createdByTeamUserId], references: [id])

  pwaApp PwaApp? @relation(fields: [pwaAppId], references: [id])

  versions      FlowVersion[] @relation("FlowVersions")
  activeVersion FlowVersion?  @relation("ActiveFlowVersion", fields: [activeVersionId], references: [id])

  eventLogs EventLog[]

  workingObjectLink WorkingObjectFlow?

  @@index([campaignId, teamId])
  @@map("flows")
}

model FlowVersion {
  id            String     @id @default(uuid())
  flowId        String     @map("flow_id")
  versionNumber Int        @map("version_number")
  status        FlowStatus @default(published)
  createdBy     String     @map("created_by")
  createdAt     DateTime   @default(now()) @map("created_at")

  flow    Flow        @relation("FlowVersions", fields: [flowId], references: [id])
  creator UserProfile @relation(fields: [createdBy], references: [id])

  activeForFlows Flow[] @relation("ActiveFlowVersion")

  @@unique([flowId, versionNumber])
  @@map("flow_versions")
}

// =========================
// EVENTS / SESSIONS / LOG PIPELINE
// =========================

model PwaSession {
  id          String  @id @default(uuid())
  pixelId     String  @map("pixel_id")
  pwaAppId    String? @map("pwa_app_id")
  campaignId  String? @map("campaign_id")
  teamId      String? @map("team_id")
  ownerUserId String? @map("owner_user_id")

  queryStringRaw String? @map("query_string_raw")

  viewContentLogId   String? @unique @map("view_content_log_id")
  leadEventLogId     String? @unique @map("lead_event_log_id")
  regEventLogId      String? @unique @map("reg_event_log_id")
  subEventLogId      String? @unique @map("sub_event_log_id")
  firstDepEventLogId String? @unique @map("first_dep_event_log_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  pixelToken PixelToken   @relation(fields: [pixelId], references: [id])
  pwaApp     PwaApp?      @relation(fields: [pwaAppId], references: [id])
  campaign   Campaign?    @relation(fields: [campaignId], references: [id])
  team       Team?        @relation(fields: [teamId], references: [id])
  owner      UserProfile? @relation(fields: [ownerUserId], references: [id])

  leadLog     EventLog? @relation("SessionLead", fields: [leadEventLogId], references: [id])
  regLog      EventLog? @relation("SessionReg", fields: [regEventLogId], references: [id])
  subLog      EventLog? @relation("SessionSub", fields: [subEventLogId], references: [id])
  firstDepLog EventLog? @relation("SessionFirstDep", fields: [firstDepEventLogId], references: [id])

  allLogs   EventLog[] @relation("SessionLogs")
  errorLogs ErrorLog[]

  @@index([pixelId, createdAt])
  @@map("pwa_sessions")
}

model SessionDeposit {
  id          String    @id @default(uuid())
  eventLogId  String    @map("event_log_id")
  amount      Decimal   @db.Decimal(18, 2)
  depositedAt DateTime? @map("deposited_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  eventLog EventLog @relation(fields: [eventLogId], references: [id])

  @@index([depositedAt])
  @@map("session_deposits")
}

model EventLog {
  id          String  @id @default(uuid())
  sessionId   String? @map("session_id")
  pixelId     String  @map("pixel_id")
  campaignId  String? @map("campaign_id")
  teamId      String? @map("team_id")
  ownerUserId String? @map("owner_user_id")
  pwaAppId    String? @map("pwa_app_id")
  flowId      String? @map("flow_id")

  eventType EventType @map("event_type")
  eventId   String    @map("event_id")
  status    LogStatus

  installId String? @map("install_id")
  fbclid    String?
  rawQuery  String? @map("raw_query")
  regionId  String? @map("region_id")
  countryId String? @map("country_id")

  os          DeviceOs?
  deviceType  DeviceType? @map("device_type")
  browser     String?
  ipAddress   String?     @map("ip_address")
  userAgent   String?     @map("user_agent")
  language    String?
  domainId    String?     @map("domain_id")
  isWhitepage Boolean?    @default(false) @map("is_whitepage")

  responseData String?  @map("response_data")
  createdAt    DateTime @default(now()) @map("created_at")

  session    PwaSession?  @relation("SessionLogs", fields: [sessionId], references: [id])
  pixelToken PixelToken   @relation(fields: [pixelId], references: [id])
  campaign   Campaign?    @relation(fields: [campaignId], references: [id])
  team       Team?        @relation(fields: [teamId], references: [id])
  owner      UserProfile? @relation(fields: [ownerUserId], references: [id])

  pwaApp PwaApp? @relation(fields: [pwaAppId], references: [id])
  flow   Flow?   @relation(fields: [flowId], references: [id])

  domain  Domain?  @relation(fields: [domainId], references: [id])
  region  Region?  @relation(fields: [regionId], references: [id])
  country Country? @relation(fields: [countryId], references: [id])

  sessionAsLead     PwaSession? @relation("SessionLead")
  sessionAsReg      PwaSession? @relation("SessionReg")
  sessionAsSub      PwaSession? @relation("SessionSub")
  sessionAsFirstDep PwaSession? @relation("SessionFirstDep")

  deposits SessionDeposit[]

  @@unique([pixelId, eventId])
  @@index([campaignId, createdAt])
  @@index([eventType, createdAt])
  @@index([regionId, createdAt])
  @@map("event_logs")
}

model Country {
  id        String     @id @default(uuid())
  code      String     @unique @db.Char(2)
  name      String
  isActive  Boolean    @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")
  regions   Region[]
  EventLog  EventLog[]

  @@index([code])
  @@map("countries")
}

model Region {
  id        String   @id @default(uuid())
  countryId String   @map("country_id")
  name      String
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  country   Country    @relation(fields: [countryId], references: [id])
  eventLogs EventLog[]

  @@index([countryId, name])
  @@map("regions")
}

// =========================
// WORKING OBJECTS
// =========================

model WorkingObject {
  id        String            @id @default(uuid())
  type      WorkingObjectType
  status    Status            @default(active)
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  // Polymorphic Links
  pwaLink        WorkingObjectPwa?
  flowLink       WorkingObjectFlow?
  pixelTokenLink WorkingObjectPixelToken?
  teamLink       WorkingObjectTeam? // 1:1 Link
  campaignLink   WorkingObjectCampaign? // 1:1 Link

  // Direct Permissions (Shares)
  sharesRole        ShareRole[]
  sharesUserProfile ShareUserProfile[]

  // Access Links for Specific Team Users
  teamUserLinks WorkingObjectTeamUser[]

  @@index([type])
  @@map("working_objects")
}

model WorkingObjectPwa {
  workingObjectId String @id @map("working_object_id")
  pwaAppId        String @unique @map("pwa_app_id")

  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  pwaApp        PwaApp        @relation(fields: [pwaAppId], references: [id], onDelete: Cascade)

  @@map("working_object_pwa")
}

model WorkingObjectFlow {
  workingObjectId String @id @map("working_object_id")
  flowId          String @unique @map("flow_id")

  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  flow          Flow          @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@map("working_object_flow")
}

model WorkingObjectPixelToken {
  workingObjectId String @id @map("working_object_id")
  pixelTokenId    String @unique @map("pixel_token_id")

  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  pixelToken    PixelToken    @relation(fields: [pixelTokenId], references: [id], onDelete: Cascade)

  @@map("working_object_pixel_token")
}

model WorkingObjectCampaign {
  workingObjectId String @id @map("working_object_id")
  campaignId      String @unique @map("campaign_id") // 1:1

  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  campaign      Campaign      @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@map("working_object_campaign")
}

model WorkingObjectTeam {
  workingObjectId String   @id @map("working_object_id")
  teamId          String   @unique @map("team_id") // 1:1
  createdAt       DateTime @default(now()) @map("created_at")

  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  team          Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("working_object_team")
}

model WorkingObjectTeamUser {
  workingObjectId String                    @map("working_object_id")
  teamUserId      String                    @map("team_user_id") // FK to TeamUser
  relation        WorkingObjectUserRelation @default(Owner)
  createdAt       DateTime                  @default(now()) @map("created_at")

  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  teamUser      TeamUser      @relation(fields: [teamUserId], references: [id], onDelete: Cascade)

  @@unique([workingObjectId, teamUserId, relation])
  @@index([teamUserId])
  @@map("working_object_team_user")
}

// =========================
// SHARES (Unified Role Sharing)
// =========================

model ShareRole {
  id              String @id @default(uuid())
  roleId          Int    @map("role_id")
  workingObjectId String @map("working_object_id")
  accessProfileId String @map("access_profile_id")

  // Who created this share (Optional relations)
  createdByCampaignUserId String? @map("created_by_campaign_user_id")
  createdByTeamUserId     String? @map("created_by_team_user_id")

  expiresAt DateTime? @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  role          Role          @relation(fields: [roleId], references: [id], onDelete: Cascade)
  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  accessProfile AccessProfile @relation(fields: [accessProfileId], references: [id])

  creatorCampaign CampaignUser? @relation("ShareRoleCreator", fields: [createdByCampaignUserId], references: [id])
  creatorTeam     TeamUser?     @relation("ShareRoleCreatorTeam", fields: [createdByTeamUserId], references: [id])

  @@unique([roleId, workingObjectId, accessProfileId])
  @@map("shares_role")
}

model ShareUserProfile {
  id              String    @id @default(uuid())
  userProfileId   String    @map("user_profile_id")
  workingObjectId String    @map("working_object_id")
  accessProfileId String    @map("access_profile_id")
  createdBy       String    @map("created_by")
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  userProfile   UserProfile   @relation("UserProfileShares", fields: [userProfileId], references: [id], onDelete: Cascade)
  workingObject WorkingObject @relation(fields: [workingObjectId], references: [id], onDelete: Cascade)
  accessProfile AccessProfile @relation(fields: [accessProfileId], references: [id])
  creator       UserProfile   @relation("UserProfileShareCreator", fields: [createdBy], references: [id])

  @@unique([userProfileId, workingObjectId, accessProfileId])
  @@map("shares_user_profile")
}

// =========================
// ACCESS PROFILE (Permissions)
// =========================

model GlobalAccessRules {
  id String @id @default(uuid())

  statAccess    AccessLevel @default(View) @map("stat_access")
  finAccess     AccessLevel @default(None) @map("fin_access")
  logAccess     AccessLevel @default(None) @map("log_access")
  usersAccess   AccessLevel @default(None) @map("users_access")
  sharingAccess AccessLevel @default(View) @map("sharing_access")

  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  accessProfiles AccessProfile[]

  @@map("global_access_rules")
}

model CrudAccessRules {
  id String @id @default(uuid())

  read   Boolean @default(true)
  update Boolean @default(false)
  delete Boolean @default(false)
  create Boolean @default(false)

  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  accessProfiles AccessProfile[]

  @@map("crud_access_rules")
}

model AccessProfile {
  id   String @id @default(uuid())
  name String @unique

  globalRulesId String? @map("global_rules_id")
  crudRulesId   String? @map("crud_rules_id")

  globalRules GlobalAccessRules? @relation(fields: [globalRulesId], references: [id])
  crudRules   CrudAccessRules?   @relation(fields: [crudRulesId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  roleAccess         RoleAccess[]
  sharesRoles        ShareRole[]
  sharesUserProfiles ShareUserProfile[]
  GlobalAccessUser   GlobalAccessUser[]

  @@map("access_profiles")
}

model GlobalAccessUser {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  accessProfileId String   @map("access_profile_id")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user          UserProfile   @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessProfile AccessProfile @relation(fields: [accessProfileId], references: [id])

  @@unique([userId])
  @@map("global_access_user")
}

// =========================
// LOGS
// =========================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  user UserProfile? @relation(fields: [userId], references: [id])

  @@index([action, createdAt])
  @@map("audit_logs")
}

model Task {
  id         String      @id @default(uuid())
  campaignId String?     @map("campaign_id")
  userId     String?     @map("user_id")
  title      String?
  status     TaskStatus?
  priority   String?
  dueDate    DateTime?   @map("due_date")
  createdAt  DateTime?   @default(now()) @map("created_at")

  campaign Campaign?    @relation(fields: [campaignId], references: [id])
  user     UserProfile? @relation(fields: [userId], references: [id])

  @@map("tasks")
}

model ErrorLog {
  id        String     @id @default(uuid())
  level     ErrorLevel @default(info)
  message   String
  stack     String?    @db.Text
  service   String?
  userId    String?    @map("user_id")
  sessionId String?    @map("session_id")
  createdAt DateTime   @default(now()) @map("created_at")

  user    UserProfile? @relation(fields: [userId], references: [id])
  session PwaSession?  @relation(fields: [sessionId], references: [id])

  @@map("error_logs")
}

model Financial {
  id              String   @id @default(uuid())
  campaignId      String   @map("campaign_id")
  spend           Decimal  @default(0.00) @db.Decimal(10, 2)
  payouts         Decimal  @default(0.00) @db.Decimal(10, 2)
  profit          Decimal  @default(0.00) @db.Decimal(10, 2)
  transactionDate DateTime @map("transaction_date") @db.Date
  campaign        Campaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId, transactionDate])
  @@map("financials")
}

model Alert {
  id         String      @id @default(uuid())
  campaignId String?     @map("campaign_id")
  type       AlertType?
  message    String?     @db.Text
  severity   ErrorLevel?
  isResolved Boolean     @default(false) @map("is_resolved")
  createdAt  DateTime?   @default(now()) @map("created_at")
  campaign   Campaign?   @relation(fields: [campaignId], references: [id])

  @@map("alerts")
}
