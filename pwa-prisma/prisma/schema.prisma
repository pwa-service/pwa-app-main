datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

enum Role {
  admin
  buyer
}

enum Status {
  active
  inactive
}

enum EventType {
  ViewContent
  PageView
  Lead
  CompleteRegistration
  Purchase
  Subscribe
}

enum LogStatus {
  success
  error
}

enum ErrorLevel {
  info
  warn
  error
  fatal
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      Role     @default(buyer)
  email     String?
  createdAt DateTime @default(now()) @map("created_at")
  status    Status   @default(active)

  PwaApp    PwaApp[]   @relation("AppCreator")
  errorLogs ErrorLog[] @relation("UserErrors")

  @@index([email])
  @@index([role])
  @@index([status])
  @@index([createdAt])
  @@map("users")
}

model PwaApp {
  id              String   @id @default(uuid())
  name            String   @unique
  domain          String   @unique
  description     String?
  templateId      Int?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  status          Status   @default(active)
  createdByUserId String   @map("created_by_user_id")
  createdBy       User     @relation("AppCreator", fields: [createdByUserId], references: [id])

  @@index([createdByUserId])
  @@index([status])
  @@index([templateId])
  @@index([createdAt])
  @@map("pwa_apps")
}

model PixelToken {
  id          String       @id @default(uuid())
  token       String
  name        String?
  description String?
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  status      Status       @default(active)
  sessions    PwaSession[] @relation("PixelTokens")

  @@index([token])
  @@index([status])
  @@index([createdAt])
  @@map("pixel_tokens")
}

model EventLog {
  id           String      @id @default(uuid())
  sessionId    String?     @map("session_id")
  pixelId      String?     @map("pixel_id")
  session      PwaSession? @relation("PwaSession", fields: [sessionId], references: [id])
  eventType    EventType   @map("event_type")
  eventId      String      @map("event_id")
  revenue      Decimal?    @db.Decimal(18, 8)
  country      String?
  clientIp     String?     @map("ip_address")
  userAgent    String?     @map("user_agent")
  responseData String?     @map("response_data")
  status       LogStatus
  createdAt    DateTime    @default(now()) @map("created_at")

  @@index([sessionId], map: "idx_eventLogs_sessionId")
  @@index([eventType], map: "idx_eventLogs_eventType")
  @@index([createdAt], map: "idx_eventLogs_createdAt")
  @@index([pixelId])
  @@index([eventId])
  @@index([status])
  @@index([country])
  @@map("event_logs")
}

model PwaSession {
  id                String     @id @unique @default(uuid())
  pwaDomain         String     @map("pwa_domain")
  landingUrl        String?    @map("landing_url")
  queryStringRaw    String?    @map("query_string_raw")
  pixelId           String     @map("pixel_id")
  pixel             PixelToken @relation("PixelTokens", fields: [pixelId], references: [id])
  fbclid            String?    @map("fbclid")
  offerId           String?    @map("offer_id")
  utmSource         String?    @map("utm_source")
  sub1              String?    @map("sub1")
  finalUrl          String?    @map("final_url")
  firstOpenAt       DateTime?  @map("first_open_at")
  firstOpenEventId  String?    @map("first_open_event_id")
  firstOpenFbStatus LogStatus? @map("first_open_fb_status")
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")

  logs      EventLog[] @relation("PwaSession")
  errorLogs ErrorLog[] @relation("SessionErrors")

  @@index([pixelId])
  @@index([pwaDomain])
  @@index([fbclid])
  @@index([offerId])
  @@index([utmSource])
  @@index([sub1])
  @@index([createdAt])
  @@map("pwa_sessions")
}

model ErrorLog {
  id      String     @id @default(uuid())
  level   ErrorLevel @default(error)
  message String
  stack   String?    @db.Text
  service String?
  context Json?
  path    String?
  method  String?

  userId String? @map("user_id")
  user   User?   @relation("UserErrors", fields: [userId], references: [id])

  sessionId String?     @map("session_id")
  session   PwaSession? @relation("SessionErrors", fields: [sessionId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([level])
  @@index([service])
  @@index([createdAt])
  @@index([userId])
  @@index([sessionId])
  @@index([path])
  @@map("error_logs")
}
