name: Deploy via Rsync & Docker Compose



on:
  push:
    branches:
      - main



concurrency:
  group: production-deploy
  cancel-in-progress: false



env:
  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}



jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4



      - name: Integration tests
        run: |
          docker compose -f docker-compose.ci.yml build
          docker compose -f docker-compose.ci.yml up -d postgres-test redis-test
          docker compose -f docker-compose.ci.yml up --abort-on-container-exit prisma-migrator-test
          docker compose -f docker-compose.ci.yml run --rm auth-tests
          docker compose -f docker-compose.ci.yml run --rm event-handler-tests
          docker compose -f docker-compose.ci.yml run --rm org-service-tests
          docker compose -f docker-compose.ci.yml down -v



      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.ci.yml down -v



  deploy:
    needs: test
    runs-on: ubuntu-latest



    steps:
      - name: Checkout repository
        uses: actions/checkout@v4



      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}



      - name: Sync repository via rsync
        run: |
          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.env' \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ \
            $DEPLOY_USER@$DEPLOY_HOST:/home/$DEPLOY_USER/pwa-app/



      - name: Upload environment variables
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          PGADMIN_DEFAULT_EMAIL: ${{ secrets.PGADMIN_DEFAULT_EMAIL }}
          PGADMIN_DEFAULT_PASSWORD: ${{ secrets.PGADMIN_DEFAULT_PASSWORD }}
        run: |
          echo "*********** Uploading .env file to remote server ***********"
          ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "mkdir -p ~/pwa-app"



          cat > .env <<EOL
          POSTGRES_DB=${POSTGRES_DB}
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL}
          PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
          EOL



          scp -o StrictHostKeyChecking=no .env $DEPLOY_USER@$DEPLOY_HOST:/home/$DEPLOY_USER/pwa-app/.env



      - name: Deploy on remote server
        run: |
          ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
            set -e
              
            # cleanup() {
            #   echo "*********** Deleting .env file ***********"
            #   rm -f ~/pwa-app/.env
            # }
            #   
            # trap cleanup EXIT
              
            cd ~/pwa-app
              
            echo "*********** Building Docker images ***********"
            if ! docker compose build --no-cache; then
              echo "Build FAILED - keeping existing containers running"
              exit 1
            fi
              
            echo "Build completed successfully"
              
            echo "*********** Stopping Docker Compose ***********"
            docker compose down
              
            echo "*********** Starting Docker Compose ***********"
            docker compose up -d --build --remove-orphans
              
            echo "*********** Checking migrations status ***********"
              
            for i in {1..30}; do
              STATUS=$(docker inspect pwa-app-prisma-migrator-1 --format='{{.State.Status}}' 2>/dev/null || echo "running")
              
              if [ "$STATUS" = "exited" ]; then
                EXIT_CODE=$(docker inspect pwa-app-prisma-migrator-1 --format='{{.State.ExitCode}}')
                if [ "$EXIT_CODE" -eq 0 ]; then
                  echo "Migrations completed successfully"
                  break
                else
                  echo "Migrations FAILED with exit code $EXIT_CODE"
                  docker compose logs prisma-migrator
                  exit 1
                fi
              fi
              
              if [ $i -eq 30 ]; then
                echo "Migrations timed out"
                docker compose logs prisma-migrator
                exit 1
              fi
              
              echo "Waiting for migrations... ($i/30)"
              sleep 2
            done
              
            echo "*********** Checking services status ***********"
            MAX_TRIES=30
            COUNT=0
            
            while [ $COUNT -lt $MAX_TRIES ]; do
              COUNT=$((COUNT+1))
              echo "Checking services... ($COUNT/$MAX_TRIES)"
              
              # Get status of all containers
              STATUS_OUTPUT=$(docker compose ps --format "table {{.Name}}\t{{.Status}}")
              
              # Check if there are any unhealthy containers
              UNHEALTHY=$(echo "$STATUS_OUTPUT" | grep -i "unhealthy" || true)
              
              if [ ! -z "$UNHEALTHY" ]; then
                echo "Found unhealthy services:"
                echo "$UNHEALTHY"
                
                if [ $COUNT -eq $MAX_TRIES ]; then
                  echo "Services failed to become healthy"
                  docker compose ps
                  docker compose logs --tail=100
                  exit 1
                fi
                
                echo ""
                sleep 1
                continue
              fi
              
              # Check that all containers are in Up status (except one-time containers)
              NOT_UP=$(docker compose ps --format "{{.Name}} {{.Status}}" | grep -v "Up" | grep -v "Exited" | grep -v "NAME" | grep -v "prisma-migrator" || true)
              
              if [ ! -z "$NOT_UP" ]; then
                echo "Waiting for services to start:"
                echo "$NOT_UP"
                
                if [ $COUNT -eq $MAX_TRIES ]; then
                  echo "Services failed to start"
                  docker compose ps
                  docker compose logs --tail=100
                  exit 1
                fi
                
                echo ""
                sleep 5
                continue
              fi

              # All OK
              echo "All services are running!"
              echo ""
              docker compose ps
              break
            done
              
            echo "*********** Cleaning up Docker resources ***********"
            docker image prune -f
            docker container prune -f
              
            echo "Deployment completed successfully"
          EOF
